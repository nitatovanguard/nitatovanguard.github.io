import{V2 as t}from"./v2.mjs";export class SpatialDB{constructor(){this.items=[]}updatePosition(t,i){this.removeItem(t),t.pos=i,this.add(t)}indexByDiscrimitator(t){if(0===this.items.length)return 0;let i=0,s=this.items.length;for(;i<s;){let e=i+(s-i>>1);this.items[e].pos.x>=t?s=e:i=e+1}return s}forEach(t){this.items.forEach(t)}size(){return this.items.length}add(t){this.items.splice(this.indexByDiscrimitator(t.pos.x),0,t)}removeItem(t){this.items.splice(this.indexOf(t),1)}removeByIndex(t){this.items.splice(t,1)}removeAllMatching(t){this.items=this.items.filter(i=>!t(i))}findFirstInRadius(t,i,s=(()=>!0)){const e=this.findAllInRadiusIt(t,i,s).next();return e.done?null:e.value}findAllInRadiusLegacy(t,i,s=(()=>!0)){return this.items.filter(e=>e.pos.getSqDist(t)<i**2&&s(e))}findAllInRadius(t,i,s=(()=>!0)){return Array.from(this.findAllInRadiusIt(t,i,s))}*findAllInRadiusIt(t,i,s=(()=>!0)){const e=i**2;for(let n=this.indexByDiscrimitator(t.x-i);n<this.items.length;++n){const r=this.items[n];if(r.pos.x-t.x>i)break;r.pos.getSqDist(t)<e&&s(r)&&(yield r)}}findAllAboveAge(t,i){return this.items.filter(s=>t-s.conception>=i)}indexOf(t){for(let i=this.indexByDiscrimitator(t.pos.x);i<this.items.length;++i){const s=this.items[i];if(s===t)return i;if(s.x>t.pos.x)break}return-1}findMaximumInRadius(t,i,s,e=(()=>!0)){let n=this.findAllInRadius(t,i,e);return n.length?n.reduce((t,i)=>s(t,i)>0?t:i):null}findNearestInRadius(t,i,s=(()=>!0)){return this.findMaximumInRadius(t,i,(i,s)=>s.pos.sub(t).sqLength()-i.pos.sub(t).sqLength(),s)}filter(t){return this.items.filter(t())}}export default{SpatialDB};